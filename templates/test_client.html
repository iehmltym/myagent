<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>MyAgent 接口测试页</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 24px;
      line-height: 1.5;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
    }
    textarea {
      width: 100%;
      max-width: 720px;
    }
    input[type="text"] {
      width: 100%;
      max-width: 720px;
    }
    button {
      margin-top: 12px;
      padding: 8px 16px;
    }
    pre {
      background: #f6f8fa;
      padding: 12px;
      border-radius: 6px;
      white-space: pre-wrap;
    }
    .row {
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <h2>MyAgent 接口测试页</h2>
  <p>用于直接调用后端接口，支持 /ask（流式）以及 /rag/ask、/agent/ask（JSON）。</p>

  <div class="row">
    <label for="apiBase">API Base</label>
    <input id="apiBase" type="text" placeholder="例如：http://localhost:8000" />
  </div>

  <div class="row">
    <label for="endpoint">接口选择</label>
    <select id="endpoint">
      <option value="/ask">POST /ask（流式）</option>
      <option value="/rag/ask">POST /rag/ask（JSON）</option>
      <option value="/agent/ask">POST /agent/ask（JSON）</option>
    </select>
  </div>

  <div class="row">
    <label for="question">问题</label>
    <textarea id="question" rows="4" placeholder="输入问题，例如：用中文解释 REST API"></textarea>
  </div>

  <div class="row">
    <label for="systemPrompt">System Prompt（仅 /ask 可选）</label>
    <textarea id="systemPrompt" rows="3" placeholder="可选：自定义 system prompt"></textarea>
  </div>

  <div class="row">
    <label for="sessionId">Session ID（/ask 或 /agent/ask 可选）</label>
    <input id="sessionId" type="text" placeholder="可选：同一会话可复用" />
  </div>

  <div class="row">
    <label for="ragMode">RAG 模式（/rag/ask 可选）</label>
    <input id="ragMode" type="text" placeholder="默认 stuff，可选 map_reduce 等" />
  </div>

  <div class="row">
    <label for="ragTopK">RAG Top K（/rag/ask 可选）</label>
    <input id="ragTopK" type="text" placeholder="默认 4" />
  </div>

  <button id="askBtn">发送请求</button>

  <h3>返回结果</h3>
  <pre id="answer">(等待请求)</pre>

  <script>
    const apiBaseInput = document.getElementById("apiBase");
    const endpointSelect = document.getElementById("endpoint");
    const questionInput = document.getElementById("question");
    const systemPromptInput = document.getElementById("systemPrompt");
    const sessionIdInput = document.getElementById("sessionId");
    const ragModeInput = document.getElementById("ragMode");
    const ragTopKInput = document.getElementById("ragTopK");
    const answerEl = document.getElementById("answer");
    const askBtn = document.getElementById("askBtn");

    function resolveApiBase() {
      const value = apiBaseInput.value.trim();
      if (value) {
        return value.replace(/\/$/, "");
      }
      if (window.location.origin && window.location.origin !== "null") {
        return window.location.origin;
      }
      return "http://localhost:8000";
    }

    function buildPayload() {
      const question = questionInput.value.trim();
      if (!question) {
        answerEl.textContent = "请先输入问题。";
        return null;
      }

      const payload = { question };
      const systemPrompt = systemPromptInput.value.trim();
      const sessionId = sessionIdInput.value.trim();
      const endpoint = endpointSelect.value;

      if (endpoint === "/ask") {
        if (systemPrompt) payload.system_prompt = systemPrompt;
        if (sessionId) payload.session_id = sessionId;
      }

      if (endpoint === "/agent/ask") {
        payload.task = payload.question;
        delete payload.question;
        if (sessionId) payload.session_id = sessionId;
      }

      if (endpoint === "/rag/ask") {
        payload.question = payload.question;
        const ragMode = ragModeInput.value.trim();
        const ragTopK = ragTopKInput.value.trim();
        if (ragMode) payload.mode = ragMode;
        if (ragTopK && !Number.isNaN(Number(ragTopK))) {
          payload.top_k = Number(ragTopK);
        }
      }

      return payload;
    }

    async function askQuestion() {
      const endpoint = endpointSelect.value;
      const payload = buildPayload();
      if (!payload) {
        return;
      }

      answerEl.textContent = "请求中...";
      askBtn.disabled = true;

      try {
        const response = await fetch(`${resolveApiBase()}${endpoint}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`HTTP ${response.status}: ${text}`);
        }

        if (endpoint === "/ask") {
          answerEl.textContent = "";
          if (!response.body) {
            const text = await response.text();
            answerEl.textContent = text || "(无返回内容)";
            return;
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            answerEl.textContent += decoder.decode(value, { stream: true });
          }
        } else {
          const data = await response.json();
          answerEl.textContent = JSON.stringify(data, null, 2);
        }
      } catch (error) {
        answerEl.textContent = `失败：${error.message}`;
      } finally {
        askBtn.disabled = false;
      }
    }

    apiBaseInput.value = resolveApiBase();
    askBtn.addEventListener("click", askQuestion);
  </script>
</body>
</html>
